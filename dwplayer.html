<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DWPLAYER - Advanced Video Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Keep all the CSS styles from the previous DWPLAYER exactly as is] */
        /* I'm not repeating the full CSS here to save space, but you should copy the complete CSS from the previous response */
        
        /* Only add these additional styles */
        .url-input-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            z-index: 2000;
            text-align: center;
        }
        
        .url-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            background: #333;
            border: 2px solid #555;
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .load-btn {
            background: #ff0000;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        
        .direct-links {
            margin-top: 20px;
        }
        
        .direct-link-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <!-- URL Input Screen (shown first) -->
        <div class="url-input-container" id="urlInputContainer">
            <h2 style="color: #ff0000; margin-bottom: 20px;">
                <i class="fab fa-youtube"></i> DWPLAYER
            </h2>
            <p style="color: #aaa; margin-bottom: 20px;">
                Enter Google Drive File ID or Full URL
            </p>
            
            <input type="text" 
                   class="url-input" 
                   id="fileIdInput" 
                   placeholder="File ID (e.g., 1BkKpTRCH4OHRDh6sf4XQ8KmrG0kKtifv)">
            
            <div style="margin: 20px 0;">
                <button class="load-btn" onclick="loadWithDirectMethod()">
                    <i class="fas fa-play"></i> Load Video
                </button>
                <button class="load-btn" onclick="loadWithProxy()" style="background: #0088cc;">
                    <i class="fas fa-cloud"></i> Load with Proxy
                </button>
            </div>
            
            <div class="direct-links">
                <p style="color: #aaa; font-size: 14px; margin-bottom: 10px;">
                    Quick Test Links:
                </p>
                <button class="direct-link-btn" onclick="testSampleVideo()">
                    <i class="fas fa-video"></i> Test Sample Video
                </button>
                <button class="direct-link-btn" onclick="openGoogleDrive()">
                    <i class="fab fa-google-drive"></i> Open Google Drive
                </button>
            </div>
            
            <p style="color: #777; font-size: 12px; margin-top: 20px;">
                If video doesn't load, try "Load with Proxy" or use the sample video
            </p>
        </div>
        
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen" style="display: none;">
            <div class="loading-spinner"></div>
            <div id="loadingText">Loading DWPLAYER...</div>
        </div>
        
        <!-- Error Screen -->
        <div class="error-screen" id="errorScreen" style="display: none;">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 id="errorTitle">Unable to Load Video</h2>
            <p id="errorMessage"></p>
            <div style="margin-top: 20px;">
                <button class="control-btn play-btn" onclick="showUrlInput()">
                    <i class="fas fa-redo"></i> Try Different Method
                </button>
                <button class="control-btn" onclick="openInNewTab()" style="background: #333; margin-left: 10px;">
                    <i class="fas fa-external-link-alt"></i> Open in New Tab
                </button>
            </div>
        </div>
        
        <!-- Video Player -->
        <video id="video-player" playsinline webkit-playsinline crossorigin="anonymous"></video>
        
        <!-- All other HTML elements (double tap, controls, etc.) remain the same -->
        <!-- [Keep all the HTML from previous response here] -->
        
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const PROXY_SERVERS = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/'
        ];
        
        const SAMPLE_VIDEO_ID = '1BkKpTRCH4OHRDh6sf4XQ8KmrG0kKtifv'; // Public sample video
        
        // ==================== INITIALIZATION ====================
        
        function initPlayer() {
            // Initialize Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.setHeaderColor('#ff0000');
                Telegram.WebApp.setBackgroundColor('#0f0f0f');
            }
            
            // Get file ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            let fileId = urlParams.get('file_id');
            
            if (fileId) {
                document.getElementById('fileIdInput').value = fileId;
                // Auto-try loading with direct method
                setTimeout(() => loadWithDirectMethod(), 500);
            }
            
            setupEventListeners();
            setupTouchControls();
            setupKeyboardControls();
        }
        
        // ==================== LOADING METHODS ====================
        
        function loadWithDirectMethod() {
            const fileId = document.getElementById('fileIdInput').value.trim();
            if (!fileId) {
                alert('Please enter a Google Drive File ID');
                return;
            }
            
            showLoading('Loading video directly...');
            
            // Try multiple direct Google Drive URLs
            const directUrls = [
                // Method 1: Direct preview (iframe method)
                `https://drive.google.com/file/d/${fileId}/preview`,
                
                // Method 2: Download link
                `https://drive.google.com/uc?export=download&id=${fileId}`,
                
                // Method 3: Alternative download link
                `https://docs.google.com/uc?export=download&id=${fileId}`,
                
                // Method 4: Google API (requires authorization in some cases)
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                
                // Method 5: Video preview
                `https://drive.google.com/file/d/${fileId}/view`
            ];
            
            // First try iframe method (most reliable for Google Drive)
            tryIframeMethod(fileId, directUrls);
        }
        
        function tryIframeMethod(fileId, fallbackUrls) {
            const videoContainer = document.getElementById('video-container');
            const existingIframe = document.getElementById('driveIframe');
            
            if (existingIframe) {
                existingIframe.remove();
            }
            
            // Create iframe for Google Drive embed
            const iframe = document.createElement('iframe');
            iframe.id = 'driveIframe';
            iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 10;
            `;
            iframe.allow = 'autoplay; fullscreen; encrypted-media; picture-in-picture';
            iframe.allowfullscreen = true;
            
            // Hide video player
            document.getElementById('video-player').style.display = 'none';
            
            // Add iframe to container
            videoContainer.appendChild(iframe);
            
            hideUrlInput();
            hideLoading();
            
            // Show success message
            showNotification('Video loaded successfully!');
            
            // Setup controls for iframe
            setupIframeControls();
        }
        
        function loadWithProxy() {
            const fileId = document.getElementById('fileIdInput').value.trim();
            if (!fileId) {
                alert('Please enter a Google Drive File ID');
                return;
            }
            
            showLoading('Loading via proxy...');
            
            // Try different proxy methods
            const proxyUrls = PROXY_SERVERS.map(proxy => 
                proxy + encodeURIComponent(`https://drive.google.com/uc?export=download&id=${fileId}`)
            );
            
            // Also try direct URLs through proxy
            const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            
            // Method 1: Try using fetch with proxy
            fetchWithProxy(directUrl, 0);
        }
        
        function fetchWithProxy(url, proxyIndex) {
            if (proxyIndex >= PROXY_SERVERS.length) {
                showError('Proxy Failed', 'All proxy servers failed. Trying direct method...');
                loadWithDirectMethod();
                return;
            }
            
            const proxyUrl = PROXY_SERVERS[proxyIndex] + encodeURIComponent(url);
            
            fetch(proxyUrl)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Proxy failed');
                })
                .then(blob => {
                    const video = document.getElementById('video-player');
                    const videoURL = URL.createObjectURL(blob);
                    
                    video.src = videoURL;
                    video.style.display = 'block';
                    
                    // Hide iframe if exists
                    const iframe = document.getElementById('driveIframe');
                    if (iframe) {
                        iframe.style.display = 'none';
                    }
                    
                    video.load();
                    
                    video.oncanplay = () => {
                        hideLoading();
                        hideUrlInput();
                        video.play().catch(e => {
                            console.log('Autoplay blocked:', e);
                        });
                        showNotification('Video loaded via proxy!');
                    };
                    
                    video.onerror = () => {
                        fetchWithProxy(url, proxyIndex + 1);
                    };
                })
                .catch(error => {
                    console.log(`Proxy ${proxyIndex} failed:`, error);
                    fetchWithProxy(url, proxyIndex + 1);
                });
        }
        
        function setupIframeControls() {
            // Add event listeners for iframe controls
            document.addEventListener('keydown', (e) => {
                const iframe = document.getElementById('driveIframe');
                if (!iframe) return;
                
                try {
                    const iframeWindow = iframe.contentWindow;
                    
                    switch(e.key.toLowerCase()) {
                        case ' ':
                        case 'k':
                            e.preventDefault();
                            iframeWindow.postMessage('playPause', '*');
                            break;
                        case 'f':
                            e.preventDefault();
                            toggleFullscreen();
                            break;
                        case 'm':
                            e.preventDefault();
                            iframeWindow.postMessage('toggleMute', '*');
                            break;
                    }
                } catch (err) {
                    console.log('Cannot control iframe:', err);
                }
            });
        }
        
        // ==================== HELPER FUNCTIONS ====================
        
        function showUrlInput() {
            document.getElementById('urlInputContainer').style.display = 'block';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            
            // Hide video elements
            document.getElementById('video-player').style.display = 'none';
            const iframe = document.getElementById('driveIframe');
            if (iframe) {
                iframe.style.display = 'none';
            }
        }
        
        function hideUrlInput() {
            document.getElementById('urlInputContainer').style.display = 'none';
        }
        
        function showLoading(text) {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('loadingText').textContent = text;
        }
        
        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }
        
        function showError(title, message) {
            hideLoading();
            hideUrlInput();
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorScreen').style.display = 'flex';
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 0, 0, 0.9);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                pointer-events: none;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -20px); }
                    15% { opacity: 1; transform: translate(-50%, 0); }
                    85% { opacity: 1; transform: translate(-50%, 0); }
                    100% { opacity: 0; transform: translate(-50%, -20px); }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 3000);
        }
        
        function testSampleVideo() {
            document.getElementById('fileIdInput').value = SAMPLE_VIDEO_ID;
            loadWithDirectMethod();
        }
        
        function openGoogleDrive() {
            const fileId = document.getElementById('fileIdInput').value.trim();
            if (fileId) {
                window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
            } else {
                window.open('https://drive.google.com', '_blank');
            }
        }
        
        function openInNewTab() {
            const fileId = document.getElementById('fileIdInput').value.trim();
            if (fileId) {
                window.open(`https://drive.google.com/file/d/${fileId}/preview`, '_blank');
            }
        }
        
        // ==================== EXTRACT FILE ID FROM URL ====================
        
        function extractFileIdFromInput() {
            const input = document.getElementById('fileIdInput').value.trim();
            
            // Patterns to match Google Drive URLs
            const patterns = [
                /\/file\/d\/([a-zA-Z0-9_-]+)/,
                /\/d\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/,
                /^([a-zA-Z0-9_-]{25,})$/
            ];
            
            for (const pattern of patterns) {
                const match = input.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            
            return input; // Return as is if no pattern matched
        }
        
        // ==================== EVENT LISTENERS ====================
        
        function setupEventListeners() {
            // Enter key support in input
            document.getElementById('fileIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadWithDirectMethod();
                }
            });
            
            // Paste event to auto-extract file ID
            document.getElementById('fileIdInput').addEventListener('paste', (e) => {
                setTimeout(() => {
                    const fileId = extractFileIdFromInput();
                    if (fileId !== document.getElementById('fileIdInput').value) {
                        document.getElementById('fileIdInput').value = fileId;
                    }
                }, 10);
            });
        }
        
        // ==================== TELEGRAM INTEGRATION ====================
        
        function setupTelegramIntegration() {
            if (!window.Telegram || !window.Telegram.WebApp) return;
            
            // Set up Telegram Web App
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // Change header color
            Telegram.WebApp.setHeaderColor('#ff0000');
            Telegram.WebApp.setBackgroundColor('#0f0f0f');
            
            // Handle back button
            Telegram.WebApp.BackButton.show();
            Telegram.WebApp.BackButton.onClick(() => {
                if (document.getElementById('urlInputContainer').style.display === 'none') {
                    showUrlInput();
                    Telegram.WebApp.BackButton.hide();
                } else {
                    Telegram.WebApp.close();
                }
            });
            
            // Update back button based on state
            const observer = new MutationObserver(() => {
                if (document.getElementById('urlInputContainer').style.display === 'none') {
                    Telegram.WebApp.BackButton.show();
                } else {
                    Telegram.WebApp.BackButton.hide();
                }
            });
            
            observer.observe(document.getElementById('urlInputContainer'), {
                attributes: true,
                attributeFilter: ['style']
            });
        }
        
        // ==================== INITIALIZE ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            initPlayer();
            setupTelegramIntegration();
            
            // Check if we have a file ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const fileId = urlParams.get('file_id');
            
            if (fileId) {
                document.getElementById('fileIdInput').value = fileId;
                // Auto-load after a short delay
                setTimeout(() => loadWithDirectMethod(), 1000);
            }
        });
        
        // Add this to handle file ID extraction when page loads
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const fileId = urlParams.get('file_id');
            
            if (fileId) {
                // Clean the file ID (remove any extra parameters)
                const cleanFileId = fileId.split('&')[0].split('?')[0];
                document.getElementById('fileIdInput').value = cleanFileId;
                
                // Show loading immediately
                showLoading('Loading video...');
                
                // Try to load after a brief delay
                setTimeout(() => {
                    loadWithDirectMethod();
                }, 500);
            }
        });
        
        // Keep all other functions from previous DWPLAYER (playback controls, UI, etc.)
        // [Copy all the remaining JavaScript functions from the previous DWPLAYER here]
        
    </script>
</body>
                    </html>
